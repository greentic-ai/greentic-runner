name: Auto tag crates on version change

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  autotag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Ensure scripts present
        run: |
          test -f scripts/version-tools.sh

      - name: Detect changed crate versions and create tags
        env:
          GIT_AUTHOR_NAME: ci-bot
          GIT_AUTHOR_EMAIL: ci-bot@users.noreply.github.com
          GIT_COMMITTER_NAME: ci-bot
          GIT_COMMITTER_EMAIL: ci-bot@users.noreply.github.com
        run: |
          set -euo pipefail
          source scripts/version-tools.sh

          # list current crates
          mapfile -t crates < <(list_crates)

          tagged_any="false"
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            changed_paths=$(git diff --name-only HEAD~1 HEAD)
          else
            changed_paths=$(git ls-tree --full-tree --name-only HEAD)
          fi

          for line in "${crates[@]}"; do
            name=$(awk '{print $1}' <<<"$line")
            version=$(awk '{print $2}' <<<"$line")
            manifest=$(awk '{print $3}' <<<"$line")
            tag="${name}-v${version}"

            # If tag already exists, skip.
            if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
              echo "::notice::Tag ${tag} already exists. Skipping."
              continue
            fi

            # Check if version changed since previous commit for this crate's Cargo.toml
            crate_dir=$(crate_dir_from_manifest "$manifest")
            if [ "$crate_dir" = "." ]; then
              cargo_toml="Cargo.toml"
            else
              cargo_toml="${crate_dir}/Cargo.toml"
            fi

            # If the file didn't change in this push, skip.
            if ! grep -Fxq "${cargo_toml}" <<<"${changed_paths}"; then
              echo "No change in ${cargo_toml} this push. Skipping ${name}."
              continue
            fi

            echo "Creating lightweight tag ${tag}"
            git tag -a "${tag}" -m "${name} ${version}"
            tagged_any="true"
          done

          if [ "$tagged_any" = "true" ]; then
            git push --tags
          else
            echo "No new crate versions detected in this push."
          fi
